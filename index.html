<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时指数行情</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Orbitron', sans-serif;
            background: #0a0a0f;
            color: #fff;
            padding: 20px;
        }

        h2 {
            text-align: center;
            font-size: 28px;
            color: #00ffff;
            text-shadow: 0 0 10px #0ff, 0 0 20px #0ff;
        }

        .index-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .index-card {
            background: linear-gradient(145deg, #1f1f2f, #2a2a40);
            padding: 20px;
            border-radius: 12px;
            width: 240px;
            box-shadow:
                0 0 10px rgba(0, 255, 255, 0.4),
                0 0 20px rgba(0, 255, 255, 0.3),
                0 0 30px rgba(0, 255, 255, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .index-card:hover,
        .index-card:active {
            transform: translateY(-5px);
            box-shadow:
                0 0 15px rgba(0, 255, 255, 0.6),
                0 0 30px rgba(0, 255, 255, 0.4),
                0 0 45px rgba(0, 255, 255, 0.2);
        }

        .index-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 8px;
            text-align: center;
            color: #0ff;
        }

        .index-price {
            font-size: 28px;
            margin-bottom: 5px;
            text-align: center;
        }

        .index-change {
            font-size: 16px;
            text-align: center;
        }

        .up {
            color: #ff4d4d;
            text-shadow: 0 0 8px #ff4d4d;
        }

        .down {
            color: #4dff4d;
            text-shadow: 0 0 8px #4dff4d;
        }

        @media (max-width: 768px) {
            .index-container {
                flex-direction: column;
                align-items: center;
            }

            .index-card {
                width: 90%;
                max-width: 350px;
                padding: 15px;
                margin-bottom: 15px;
            }

            .index-name {
                font-size: 20px;
            }

            .index-price {
                font-size: 28px;
            }

            .index-change {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            h2 {
                font-size: 24px;
            }

            .index-name {
                font-size: 18px;
            }

            .index-price {
                font-size: 24px;
            }

            .index-change {
                font-size: 16px;
            }

            .index-card {
                padding: 12px;
            }
        }

        /* 数字滚动样式 */
        .digit {
            display: inline-block;
            width: 0.8em;
            /* 数字宽度 */
            overflow: hidden;
            position: relative;
            margin: 0 1px;
            /* 数字间距 */
        }

        .digit span {
            display: block;
            transition: transform 0.3s ease-in-out;
        }

        .digit span.new {
            position: absolute;
            top: -100%;
            /* 新数字从上方进入，实现向下滚动 */
        }
    </style>
</head>

<body>
    <h2>实时指数行情</h2>
    <div class="index-container">
        <div class="index-card" id="sh000001">
            <div class="index-name">上证指数</div>
            <div class="index-price">--</div>
            <div class="index-change">--</div>
        </div>
        <div class="index-card" id="sz399001">
            <div class="index-name">深证成指</div>
            <div class="index-price">--</div>
            <div class="index-change">--</div>
        </div>
        <div class="index-card" id="sh000300">
            <div class="index-name">沪深300</div>
            <div class="index-price">--</div>
            <div class="index-change">--</div>
        </div>
        <div class="index-card" id="sh000016">
            <div class="index-name">上证50</div>
            <div class="index-price">--</div>
            <div class="index-change">--</div>
        </div>
        <div class="index-card" id="IXIC">
            <div class="index-name">纳斯达克</div>
            <div class="index-price">--</div>
            <div class="index-change">--</div>
        </div>
        <div class="index-card" id="N225">
            <div class="index-name">日经225</div>
            <div class="index-price">--</div>
            <div class="index-change">--</div>
        </div>
    </div>

    <script>
        // 判断是否在中国股市交易时间（周一至周五，09:30-11:30，13:00-15:00）
        function isMarketOpen() {
            const now = new Date();
            const day = now.getDay();
            if (day === 0 || day === 6) return false; // 周末停盘

            const hours = now.getHours();
            const minutes = now.getMinutes();
            const totalMinutes = hours * 60 + minutes;

            const morningStart = 9 * 60 + 30;
            const morningEnd = 11 * 60 + 30;
            const afternoonStart = 13 * 60;
            const afternoonEnd = 15 * 60;

            return (totalMinutes >= morningStart && totalMinutes <= morningEnd) ||
                (totalMinutes >= afternoonStart && totalMinutes <= afternoonEnd);
        }

        async function fetchChinaIndex(code) {
            try {
                const res = await fetch(`https://qt.gtimg.cn/q=${code}`);
                const text = await res.text();
                const str = text.split('=')[1].trim().replace(/[";]/g, '');
                const fields = str.split("~");
                return {
                    price: fields[3],
                    change: fields[31],
                    changePct: fields[32]
                };
            } catch (e) {
                console.error(code, e);
                return { price: '--', change: '--', changePct: '--' };
            }
        }

        async function fetchGlobalIndex(symbol) {
            try {
                const res = await fetch(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbol}`);
                const data = await res.json();
                const quote = data.quoteResponse.result[0];
                if (!quote) return { price: '--', change: '--', changePct: '--' };
                return {
                    price: quote.regularMarketPrice.toFixed(2),
                    change: quote.regularMarketChange.toFixed(2),
                    changePct: quote.regularMarketChangePercent.toFixed(2)
                };
            } catch (e) {
                console.error(symbol, e);
                return { price: '--', change: '--', changePct: '--' };
            }
        }

        // 初始化数字
        function initDigits(element, number) {
            element.innerHTML = '';
            const str = number.toString();
            for (let i = 0; i < str.length; i++) {
                const digitContainer = document.createElement('span');
                digitContainer.className = 'digit';
                const span = document.createElement('span');
                span.textContent = str[i];
                digitContainer.appendChild(span);
                element.appendChild(digitContainer);
            }
        }

        // 更新数字，只滚动变化位，向下滚动
        function updateDigits(element, newNumber) {
            const newStr = newNumber.toString();
            const digitElems = element.querySelectorAll('.digit');

            while (digitElems.length < newStr.length) {
                const digitContainer = document.createElement('span');
                digitContainer.className = 'digit';
                const span = document.createElement('span');
                span.textContent = '0';
                digitContainer.appendChild(span);
                element.appendChild(digitContainer);
            }

            const updatedDigits = element.querySelectorAll('.digit');
            for (let i = 0; i < newStr.length; i++) {
                const digitContainer = updatedDigits[i];
                const oldSpan = digitContainer.querySelector('span');
                if (oldSpan.textContent !== newStr[i]) {
                    const newSpan = document.createElement('span');
                    newSpan.textContent = newStr[i];
                    newSpan.className = 'new';
                    digitContainer.appendChild(newSpan);

                    setTimeout(() => {
                        oldSpan.style.transform = 'translateY(100%)';
                        newSpan.style.transform = 'translateY(100%)';
                    }, 10);

                    setTimeout(() => {
                        oldSpan.remove();
                        newSpan.className = '';
                        newSpan.style.transform = 'none';
                    }, 350);
                }
            }
        }

        let firstLoad = true;

        async function updateIndices() {
            if (!firstLoad && !isMarketOpen()) {
                console.log("非交易时间，暂停更新");
                return; // 非第一次且非交易时间，不请求
            }

            const chinaIndices = ['sh000001', 'sz399001', 'sh000300', 'sh000016'];
            for (let code of chinaIndices) {
                const data = await fetchChinaIndex(code);
                const card = document.getElementById(code);
                const ch = parseFloat(data.change);
                const sign = ch >= 0 ? '+' : '-';

                const priceElem = card.querySelector('.index-price');
                if (priceElem.textContent.trim() === '--') {
                    initDigits(priceElem, data.price);
                } else {
                    updateDigits(priceElem, data.price);
                }

                const changeElem = card.querySelector('.index-change');
                changeElem.textContent = `${sign}${Math.abs(data.change)} (${sign}${Math.abs(data.changePct)}%)`;
                changeElem.className = 'index-change ' + (ch >= 0 ? 'up' : 'down');
            }

            const globalIndices = { 'IXIC': '纳斯达克', 'N225': '日经225' };
            for (let symbol in globalIndices) {
                const data = await fetchGlobalIndex(symbol);
                const card = document.getElementById(symbol);
                const ch = parseFloat(data.change);
                const sign = ch >= 0 ? '+' : '-';

                const priceElem = card.querySelector('.index-price');
                if (priceElem.textContent.trim() === '--') {
                    initDigits(priceElem, data.price);
                } else {
                    updateDigits(priceElem, data.price);
                }

                const changeElem = card.querySelector('.index-change');
                changeElem.textContent = `${sign}${Math.abs(data.change)} (${sign}${Math.abs(data.changePct)}%)`;
                changeElem.className = 'index-change ' + (ch >= 0 ? 'up' : 'down');
            }

            firstLoad = false;
        }

        // 启动定时更新，每3秒
        updateIndices();
        setInterval(updateIndices, 3000);
    </script>
</body>

</html>